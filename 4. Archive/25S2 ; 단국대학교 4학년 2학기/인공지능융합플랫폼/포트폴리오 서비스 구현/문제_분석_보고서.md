# 파이프라인 실행 문제 분석 보고서

**분석 일시**: 2025년 12월 7일  
**실행 명령**: `uv run python main.py`  
**결과**: 텍스트 분석 실패 → Fallback 모드, 이미지 분석 부분 실패

---

## 📊 실행 결과 요약

### 1단계: JSON 변환 ✅ 성공

- 텍스트 파일 → JSON 변환 정상 작동

### 2단계: 텍스트 분석 ❌ 실패

- **Solar API 호출 실패**
- Fallback 모드로 전환
- 결과: `role` 필드가 "분석 실패"로 설정됨

### 3단계: 이미지 분석 ⚠️ 부분 실패

- 이미지 캡션 생성 실패 (11개 모두)
- 유사도 계산 실패 (모든 이미지)
- 결과: 모든 포스트에 동일한 이미지 매칭됨 (유사도 0.0)

---

## 🔴 발견된 문제

### 문제 1: `prompt_templates.py` 데이터 구조 오류 ⭐ **최우선**

**위치**: `Feed_analysis_module/prompt_templates.py` 2번 줄

**오류 내용**:

```python
# 잘못된 구조 (리스트)
Templates = [{...}, {...}]
```

**오류 메시지**:

```
TypeError: list indices must be integers or slices, not str
  File "text_analysis.py", line 113, in analyze_text_with_upstage
    prompt_template = Templates["text_analysis_prompt"]
```

**원인**:

- `Templates`가 딕셔너리가 아닌 **리스트**로 정의됨
- `Templates["text_analysis_prompt"]` 형태로 접근 시도
- 리스트는 문자열 키로 접근할 수 없음

**영향**:

- Solar API가 **전혀 호출되지 않음**
- 즉시 `TypeError` 발생
- Fallback 모드로 전환

**수정 완료** ✅:

```python
# 올바른 구조 (딕셔너리)
Templates = {
    "text_analysis_prompt": "...",
    "image_analysis_prompt": "..."
}
```

---

### 문제 2: Gemini API 호출 방식 오류

**위치**: `Feed_analysis_module/image_analysis.py` 68번 줄

**오류 내용**:

```python
uploaded_file = client.files.upload(path=image_path)  # ❌ 잘못된 파라미터
```

**오류 메시지**:

```
Files.upload() got an unexpected keyword argument 'path'
```

**원인**:

- Gemini API의 `files.upload()` 메서드는 `path` 파라미터를 지원하지 않음
- 올바른 파라미터는 `file`

**수정 완료** ✅:

```python
uploaded_file = client.files.upload(file=image_path)  # ✅ 올바른 파라미터
```

---

### 문제 3: Gemini API 할당량 초과 ⚠️

**오류 메시지**:

```
429 RESOURCE_EXHAUSTED
Quota exceeded for metric: generativelanguage.googleapis.com/generate_content_free_tier_requests
```

**원인**:

- Gemini API 무료 티어 일일/분당 요청 한도 초과
- 3가지 할당량 모두 초과:
  1. `generate_content_free_tier_input_token_count` (분당 입력 토큰)
  2. `generate_content_free_tier_requests` (분당 요청)
  3. `generate_content_free_tier_requests` (일일 요청)

**대기 시간**: 약 7-33초 후 재시도 가능

**해결 방안**:

1. **유료 플랜 업그레이드** (권장)
2. **다른 API 키 사용**
3. **내일까지 대기** (일일 한도 리셋)
4. **요청 수 줄이기** (배치 처리, 캐싱 등)

---

## 🔍 상세 분석

### Solar API가 사용되지 않은 실제 원인

**이전 분석에서 의심한 원인** (틀림):

- `load_dotenv()` 경로 문제
- API 키 로드 실패

**실제 원인** ✅:

- `Templates` 데이터 구조 오류
- API 키 로드 전에 이미 `TypeError` 발생
- API 호출 코드에 도달하지도 못함

**증거**:

1. 터미널 로그 40-48번 줄: `TypeError` 발생
2. API 로그 없음 → API 호출 시도조차 없었음
3. Fallback 모드 즉시 활성화

---

## 📈 실행 흐름 분석

### 실제 실행 흐름

```
1. main.py 실행
   ↓
2. JSON 변환 ✅ 성공
   ↓
3. analyze_text_with_upstage() 호출
   ↓
4. Templates["text_analysis_prompt"] 접근 시도
   ↓
5. ❌ TypeError 발생 (리스트는 문자열 키 불가)
   ↓
6. 예외 처리 → Fallback 모드 활성화
   ↓
7. Fallback 결과 생성 ✅
   ↓
8. match_images_to_posts() 호출
   ↓
9. generate_image_caption() 호출 (11개 이미지)
   ↓
10. ❌ Files.upload(path=...) 오류 발생
    ↓
11. 대체 방법 시도
    ↓
12. ❌ 429 RESOURCE_EXHAUSTED (API 할당량 초과)
    ↓
13. 빈 캡션("") 반환
    ↓
14. 유사도 계산 시도
    ↓
15. ❌ 429 RESOURCE_EXHAUSTED (API 할당량 초과)
    ↓
16. 유사도 0.0 반환
    ↓
17. 모든 포스트에 첫 번째 이미지 매칭 (유사도 0.0)
    ↓
18. 결과 저장 ✅
```

---

## 🎯 수정 사항

### ✅ 완료된 수정

1. **`prompt_templates.py`**: 리스트 → 딕셔너리 변경
2. **`image_analysis.py`**: `path=` → `file=` 파라미터 수정
3. **`text_analysis.py`**: `load_dotenv()` 경로 명시 (이전 수정)
4. **`image_analysis.py`**: `load_dotenv()` 경로 명시 (이전 수정)
5. **`main.py`**: `load_dotenv()` 추가 (이전 수정)

---

## 🔧 다음 단계

### 즉시 실행 가능

1. **Solar API 테스트**:
   ```bash
   uv run python main.py
   ```
   → `prompt_templates.py` 수정으로 Solar API가 정상 작동해야 함

### Gemini API 할당량 문제 해결

**옵션 A: 유료 플랜 업그레이드** (권장)

- 안정적인 서비스 제공
- 높은 할당량

**옵션 B: 다른 API 키 사용**

- 새 프로젝트 생성
- 다른 계정의 API 키 사용

**옵션 C: 내일 재시도**

- 일일 할당량 리셋 대기
- 무료 옵션

**옵션 D: 이미지 분석 최적화**

- 캡션 캐싱
- 배치 처리
- 요청 수 줄이기

---

## 📝 결론

### 주요 발견

1. **Solar API 미사용 원인**: `Templates` 데이터 구조 오류 (리스트 → 딕셔너리)
2. **Gemini API 오류**: 잘못된 파라미터 + 할당량 초과
3. **이전 분석의 오류**: `load_dotenv()` 문제는 실제 원인이 아니었음

### 수정 후 예상 결과

- ✅ Solar API 정상 작동
- ✅ 텍스트 분석 성공
- ⚠️ 이미지 분석은 Gemini API 할당량 문제 해결 필요

### 성공률 예상

| 단계             | 수정 전 | 수정 후 예상 |
| ---------------- | ------- | ------------ |
| JSON 변환        | 100%    | 100%         |
| 텍스트 분석      | 0%      | 100% ✅      |
| 이미지 캡션 생성 | 0%      | 0% (할당량)  |
| 이미지 매칭      | 0%      | 0% (할당량)  |

**전체 파이프라인 성공률**: 25% → **50%** (Solar API 수정 후)

Gemini API 할당량 문제 해결 시 → **100%** 달성 가능

---

**작성**: AI Assistant  
**검증**: 터미널 로그, 소스 코드 분석, 결과 파일 확인
