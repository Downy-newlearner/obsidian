## **프롬프트 수정**
- ![[Pasted image 20250724213736.png]]
- ![[Pasted image 20250724213745.png]]

## **analyze_chat_history() 로직 개선**
- 기존 기준
```
if len(chat_history.messages) < 10:
	raise ValueError("Chat history must be at least 10 messages")
```

- **개선 방향:**
    
    → 대화 히스토리를 LLM에게 보내서 “이야기 파악이 충분한지”를 판단하게 한다.
    
    → 예: 육하원칙 기반 체크 (누가, 언제, 무엇을, 왜, 어떻게)가 최소 3개 이상 언급되면 ‘파악 완료’로 간주.

- 프롬프트 추가 후 함수 변경함

## **run_chatbot_once() 함수의 트리거 분기 조건 변경**
- 기존 analyze_chat_history() 함수처럼 10턴 기준으로만 분석 여부를 판단했다.
- 하지만 이미 analyze_chat_history() 단계에서 이야기 파악 여부를 판단하고 있으므로 그 결과를 기준으로 판단한다.

- **수정 방향**
	1. analyze_chat_history() 수행 성공 여부가 핵심임
    
	    → chat_analysis가 state에 존재하면 "이야기 파악 완료"로 간주
    
	2. run_chatbot_once() 내부에서 다음 조건으로 분기해야 함:
			```
	```
	if self.state.get("chat_analysis"):
	    if self.state.get('advice') and self.state.get('keywords'):
	        ...
	```

- **변경 후 기준**
	- chat_analysis 필드 존재 여부