`double free` 버그는 메모리 관리에서 발생하는 심각한 취약점 중 하나로, 방어적 프로그래밍과 시스템 안정성 측면에서 중요한 문제입니다. `double free` 버그는 동일한 메모리 블록을 두 번 해제하려 할 때 발생합니다. 이로 인해 메모리 할당 시스템의 상태가 불안정해지고, 잠재적으로 심각한 보안 문제를 야기할 수 있습니다.
### 메모리 할당 및 해제 과정
일반적으로 메모리 할당과 해제는 아래와 같은 과정으로 이루어집니다:
1. **메모리 할당** : `malloc`, `calloc`, `realloc` 함수를 통해 메모리 블록을 요청합니다. 이 함수들은 힙(heap) 영역에서 메모리 블록을 할당하고, 해당 블록의 시작 주소를 반환합니다.
    
    ```C
    
    int *ptr = (int *)malloc(sizeof(int) * 10);  // 10개의 정수 배열 메모리 할당
    
    ```
    
2. **메모리 사용** : 할당된 메모리 블록에 데이터를 읽고 쓸 수 있습니다.
    
    ```C
    
    ptr[0] = 1;
    
    ```
    
3. **메모리 해제** : 사용이 끝난 메모리 블록은 `free` 함수를 통해 해제하여 힙 메모리에서 반환됩니다.
    
    ```C
    
    free(ptr);
    
    ```
    
### Double Free 예제
`double free` 오류는 동일한 포인터를 두 번 해제하려고 할 때 발생합니다. 이로 인해 메모리 할당 관리자(free list 등)는 잘못된 상태가 되어 프로그램의 비정상 종료 또는 이로 인한 보안 취약점(예: 메모리 손상, 악성 코드 주입 등)이 발생할 수 있습니다.
### 예제 코드
```C
\#include <stdlib.h>

int main() {
    int *ptr = (int *)malloc(sizeof(int) * 10);  // 메모리 할당
    if (ptr == NULL) {
        return 1;  // 메모리 할당 실패 시 종료
    }

    // 메모리 사용

    free(ptr);  // 첫 번째 해제
    free(ptr);  // 두 번째 해제 (double free)

    return 0;
}
```
### Double Free의 위험성
### 1. **메모리 손상 (Memory Corruption)**
- `free` 함수는 일반적으로 메모리 블록을 해제 후, 해당 블록을 관리하는 데이터 구조(free list 등)에 추가합니다. 동일한 블록을 두 번 이상 해제하면, free list가 손상되어 메모리 할당 시스템의 상태가 불안해집니다.
[[free list란]]
### 2. **보안 취약점 (Security Vulnerabilities)**
- `double free`는 공격자가 악용할 수 있는 상당한 보안 위험 요소입니다. 이를 통해 공격자는 프로그램의 동작을 제어하거나, 원하는 주소로 shellcode를 주입하여 악성 행위를 수행할 수 있습니다.
### 방어적 프로그래밍 기법
### 1. **포인터 무효화**
- 메모리를 해제한 후, 포인터를 NULL로 설정하여 다시 해제되지 않도록 합니다:
````Plain
```c
free(ptr);
ptr = NULL;
```
````
### 2. **중복 해제 검사**
- 메모리를 해제하기 전에 포인터가 NULL인지 검사합니다:
````Plain
```c
if (ptr != NULL) {
    free(ptr);
    ptr = NULL;
}
```
````
### 3. **스마트 포인터 사용**
- C++에서는 스마트 포인터(`std::unique_ptr`, `std::shared_ptr` 등)를 사용하여 자동 메모리 관리를 통해 이러한 문제를 방지할 수 있습니다.
### 우리가 Double Free 취약점을 해결할 수 있는 방법
### 표준 라이브러리 함수
- 많은 최신 표준 라이브러리 함수들은 이미 다양한 메모리 관련 이슈를 해결하기 위해 노력해왔으며, 호환성을 유지합니다. 최신 라이브러리 사용을 권장합니다.
### 정적 분석 도구 및 런타임 검증
- 이와 같은 취약점을 자동으로 찾아내는 정적 분석 도구나, 런타임 검증 도구를 이용하여 코드 품질을 높일 수 있습니다. 예를 들어, Valgrind는 메모리 관련 오류를 탐지하는 데 유용합니다.
```Plain
valgrind --leak-check=full ./your_executable
```
### 결론
`double free` 버그는 메모리 관리에서 발생하는 심각한 문제로, 프로그램의 안정성을 해치고 보안 취약점을 초래할 수 있습니다. 이를 피하기 위해 포인터 무효화, 중복 해제 검사, 스마트 포인터 사용, 최신 라이브러리 이용 등의 방어적 프로그래밍 기법을 적용하는 것이 중요합니다.